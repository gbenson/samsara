#!/usr/bin/env python

### Preamble: allow this program to be run without PYTHON_PATH abuse
import sys, os
samsara_dir = os.path.dirname(os.path.dirname(os.path.realpath(sys.argv[0])))
if samsara_dir not in sys.path:
    sys.path.insert(0, samsara_dir)
### end of preamble

from samsara.httpserver import HTTPServer
from samsara.server import SamsaraServer
import glob
import socket

hostname = socket.gethostbyaddr(socket.gethostname())[0]
if hostname == "blade.nx":
    host = ""
else:
    host = "127.0.0.1"

roots = sys.argv[1:]
if not roots:
    print >>sys.stderr, "usage: %s ROOT..."
    sys.exit(1)
if len(roots) == 1:
    paths = glob.glob(os.path.join(roots[0], "*", "[Ss]amsara"))
    if paths:
        roots = map(os.path.dirname, paths)

for root, needs_fork in zip(roots, [True] * (len(roots) - 1) + [False]):
    if needs_fork and os.fork():
        continue
    server = SamsaraServer(root)
    port = int(server.config.get("httpserver", "port"))
    HTTPServer((host, port), server).serve_forever()
